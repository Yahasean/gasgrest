<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµ‚æ¥µç‰©ç†çƒæ± </title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #141e30, #243b55);
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }

        canvas { display: block; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 100;
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #control-panel.collapsed {
            transform: translateY(-100%);
        }

        #toggle-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 101;
            background: rgba(0, 198, 255, 0.9);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .control-group:last-child { margin-bottom: 0; }
        
        .control-group label {
            width: 70px;
            font-size: 13px;
            color: #bbb;
            font-weight: 500;
        }
        .control-group input {
            flex: 1;
            margin: 0 15px;
            cursor: pointer;
        }
        .control-group span {
            width: 25px;
            text-align: right;
            font-size: 13px;
            font-weight: bold;
            color: #00c6ff;
        }

        /* å•Ÿå‹•é®ç½© */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 30, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }

        #start-btn {
            padding: 18px 45px;
            font-size: 20px;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(0, 198, 255, 0.4);
            transition: transform 0.1s;
        }
        #start-btn:active { transform: scale(0.95); }

        /* æ–æ™ƒå›é¥‹æ–‡å­— */
        #shake-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.9);
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 40px rgba(0, 198, 255, 0.8);
            z-index: 50;
            transition: opacity 0.1s;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn">å•Ÿå‹•ç‰©ç†å¼•æ“</button>
        <p style="color:#666; margin-top:15px; font-size:14px;">å»ºè­°é–å®šç›´å‘è¢å¹•</p>
    </div>

    <div id="shake-feedback">BOOM!</div>
    <button id="toggle-btn">âš™ï¸</button>

    <div id="control-panel">
        <div class="control-group">
            <label>æ•¸é‡</label>
            <input type="range" id="input-count" min="10" max="300" value="120" step="10">
            <span id="val-count">120</span>
        </div>
        <div class="control-group">
            <label>å¤§å°</label>
            <input type="range" id="input-size" min="10" max="50" value="20" step="2">
            <span id="val-size">20</span>
        </div>
        <div class="control-group">
            <label style="color: #ffd700;">é‡é‡</label>
            <input type="range" id="input-weight" min="1" max="10" value="3" step="1">
            <span id="val-weight">3</span>
        </div>
        <div class="control-group">
            <label>æ™ƒå‹•é–¥å€¼</label>
            <input type="range" id="input-shake" min="5" max="40" value="12" step="1">
            <span id="val-shake">12</span>
        </div>
    </div>

    <canvas id="world"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        // --- Matter.js åŸºç¤è¨­å®š ---
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body;

        const engine = Engine.create();
        const world = engine.world;
        
        // å¢åŠ ç‰©ç†è¿­ä»£æ¬¡æ•¸ï¼Œè®“ç¢°æ’æ›´ç²¾ç¢º (è§£æ±ºçƒç©¿é€å•é¡Œ)
        engine.positionIterations = 8;
        engine.velocityIterations = 8;

        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        let balls = [];
        let walls = [];
        let wallBodies = {};

        // è‰²å½©åº«
        const colors = ['#ff3366', '#ff6633', '#FFCC00', '#33cc99', '#3399ff', '#cc33ff'];

        // --- åƒæ•¸è¨­å®š ---
        let config = {
            count: 120,
            radius: 20,
            weight: 3,      // 1~10
            shakeThreshold: 12
        };

        // --- 1. ç‰†å£ç³»çµ± (è‡ªå‹•é©é…è¢å¹•) ---
        function updateWalls() {
            World.remove(world, walls);
            walls = [];
            
            const thick = 500; // åšä¸€é»é˜²æ­¢ç©¿é€
            const opts = { isStatic: true, render: { visible: false }, friction: 0.5 };
            
            wallBodies.top = Bodies.rectangle(width/2, -thick/2, width*2, thick, opts);
            wallBodies.bottom = Bodies.rectangle(width/2, height+thick/2, width*2, thick, opts);
            wallBodies.left = Bodies.rectangle(-thick/2, height/2, thick, height*2, opts);
            wallBodies.right = Bodies.rectangle(width+thick/2, height/2, thick, height*2, opts);
            
            walls = [wallBodies.top, wallBodies.bottom, wallBodies.left, wallBodies.right];
            World.add(world, walls);
        }

        // --- 2. çƒé«”ç³»çµ± ---
        function getDensity() {
            // é‡é‡æ»‘æ¡¿ 1~10 å°æ‡‰å¯†åº¦ 0.001 ~ 0.05
            // é è¨­ Matter.js å¯†åº¦ç´„ 0.001
            return 0.001 + (config.weight - 1) * 0.005;
        }

        function rebuildBalls() {
            World.remove(world, balls);
            balls = [];

            const density = getDensity();

            for(let i = 0; i < config.count; i++) {
                const r = config.radius * (0.8 + Math.random() * 0.4); // å¤§å°å¾®å¹…éš¨æ©Ÿ
                const x = Math.random() * (width - 100) + 50;
                const y = Math.random() * (height * 0.6); 

                const ball = Bodies.circle(x, y, r, {
                    restitution: 0.6, // å½ˆæ€§
                    friction: 0.005,  // æ‘©æ“¦åŠ› (å°ä¸€é»æ¯”è¼ƒæ»‘)
                    density: density, // é‡é‡é—œéµ
                    frictionAir: 0.01, // ç©ºæ°£é˜»åŠ›
                    render: {
                        fillStyle: colors[Math.floor(Math.random() * colors.length)]
                    }
                });
                balls.push(ball);
            }
            World.add(world, balls);
        }

        // æ›´æ–°ç¾æœ‰çƒé«”çš„é‡é‡ (ä¸éœ€é‡å»º)
        function updateBallWeights() {
            const newDensity = getDensity();
            balls.forEach(b => {
                Body.setDensity(b, newDensity);
            });
        }

        // --- 3. æ¸²æŸ“ç³»çµ± ---
        const bubbles = Array.from({length: 30}, () => ({
            x: Math.random()*width, y: Math.random()*height, r: Math.random()*4+2, s: Math.random()*2+0.5
        }));

        function render() {
            Engine.update(engine, 1000 / 60);
            ctx.clearRect(0, 0, width, height);

            // 1. èƒŒæ™¯æ°£æ³¡
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            bubbles.forEach(b => {
                b.y -= b.s;
                if(b.y < -10) b.y = height + 10;
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                ctx.fill();
            });

            // 2. ç‰©ç†çƒ
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.position.x, b.position.y, b.circleRadius, 0, Math.PI*2);
                
                // å¯¦å¿ƒè‰²
                ctx.fillStyle = b.render.fillStyle;
                ctx.fill();
                
                // ç«‹é«”å…‰æ¾¤
                ctx.fillStyle = 'rgba(255,255,255,0.25)';
                ctx.beginPath();
                ctx.arc(b.position.x - b.circleRadius*0.3, b.position.y - b.circleRadius*0.3, b.circleRadius*0.4, 0, Math.PI*2);
                ctx.fill();
            });

            requestAnimationFrame(render);
        }

        // --- 4. æ ¸å¿ƒç‰©ç†æ§åˆ¶ (Shake + Tilt) ---
        
        // å„²å­˜æœ€æ–°çš„åŠ é€Ÿåº¦å‘é‡
        let motionVector = { x: 0, y: 0 };
        const shakeText = document.getElementById('shake-feedback');
        let shakeCooldown = false;

        function handleMotion(e) {
            // 1. å–å¾—åŠ é€Ÿåº¦ (å«é‡åŠ›)
            // å¦‚æœæ‰‹æ©Ÿæ²’æœ‰ accelerationIncludingGravityï¼Œæœ‰äº›èˆŠæ©Ÿå‹å¯èƒ½åªæœ‰ acceleration
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if (!acc) return;

            // 2. è¨ˆç®—ã€Œæ–æ™ƒå¼·åº¦ã€(å»é™¤é‡åŠ›å¾Œçš„ç¬æ™‚åŠ é€Ÿåº¦è®ŠåŒ–)
            // é€™è£¡æˆ‘å€‘ç”¨ä¸€å€‹ç°¡åŒ–çš„æ–¹å¼ï¼šç›´æ¥çœ‹ acc çš„æ•¸å€¼å¤§å°è®ŠåŒ–
            // ç‚ºäº†æ›´ç²¾ç¢ºï¼Œæˆ‘å€‘é€™è£¡ç›´æ¥æ‹¿ acc ä¾†åšæ…£æ€§æ¨åŠ›
            
            // æ³¨æ„ï¼šAndroid å’Œ iOS çš„ acc åº§æ¨™è»¸å¯èƒ½ç›¸åï¼Œé€™è£¡åšä¸€å€‹é€šç”¨è™•ç†
            // é€šå¸¸ x è»¸æ­£å‘æ˜¯å‘å³ã€‚å¦‚æœæˆ‘å‘å³ç”¨åŠ›ç”© (acc.x > 0)ï¼Œçƒæ‡‰è©²å› ç‚ºæ…£æ€§å‘å·¦é£› (Force X < 0)
            // æ‰€ä»¥åŠ›é“ = -acc
            
            const forceMultiplier = 0.0005 * config.weight; // é‡é‡è¶Šé‡ï¼Œéœ€è¦çš„æ¨åŠ›ä¿‚æ•¸è¦å¾®èª¿ï¼Œæˆ–è€…è®“ç‰©ç†å¼•æ“è‡ªå·±è™•ç† F=ma

            // å°‡åŠ é€Ÿåº¦å¹³æ»‘åŒ–ä¸€é»é»ï¼Œé¿å…æ•¸æ“šæŠ–å‹•
            const ax = acc.x || 0;
            const ay = acc.y || 0;

            // 3. å¯¦æ™‚æ–½åŠ æ…£æ€§åŠ› (é€™æ˜¯éˆæ•åº¦çš„é—œéµï¼)
            // æˆ‘å€‘ä¸ç­‰åˆ°ã€Œè§¸ç™¼çˆ†ç‚¸ã€ï¼Œè€Œæ˜¯æ¯ä¸€å¹€éƒ½æ–½åŠ é€™å€‹åŠ›
            // ä½†ç‚ºäº†é¿å…å¹²æ“¾ Gravity (Tilt)ï¼Œæˆ‘å€‘åªå°ã€Œå¿«é€Ÿè®ŠåŒ–ã€çš„åŠ é€Ÿåº¦åšåæ‡‰
            // æˆ–è€…æ›´ç°¡å–®ï¼šç›´æ¥ç–ŠåŠ åŠ›é“ã€‚
            
            balls.forEach(b => {
                // åå‘æ–½åŠ› (æ¨¡æ“¬æ…£æ€§)
                // x: -ax, y: -ay
                // ä½†å› ç‚ºæˆ‘å€‘å·²ç¶“æœ‰ Gravity åœ¨ä½œç”¨ï¼Œé€™è£¡ä¸»è¦é‡å°ã€Œç”©å‹•ã€çš„é¡å¤–åŠ›
                // iOS/Android å·®ç•°ï¼šè‹¥ç™¼ç¾æ–¹å‘åäº†ï¼Œå¯ä»¥èª¿æ•´é€™è£¡çš„æ­£è² è™Ÿ
                
                // æˆ‘å€‘å¯ä»¥çµ¦ä¸€å€‹è¼ƒå°çš„ä¿‚æ•¸æŒçºŒä½œç”¨ï¼Œè®“æ°´å¹³ç§»å‹•ä¹Ÿæœ‰æ„Ÿ
                Body.applyForce(b, b.position, {
                    x: -ax * 0.0002 * b.mass, // ä½¿ç”¨ b.mass ç¢ºä¿é‡çƒä¹Ÿæ¨å¾—å‹•
                    y: -ay * 0.0002 * b.mass 
                });
            });

            // 4. åŠ‡çƒˆæ–æ™ƒè§¸ç™¼ç‰¹æ•ˆ (è¦–è¦ºå›é¥‹)
            // è¨ˆç®—ç¸½åŠ é€Ÿåº¦é‡
            const totalAcc = Math.abs(ax) + Math.abs(ay) + Math.abs(acc.z || 0);
            
            if (!shakeCooldown && totalAcc > config.shakeThreshold + 9.8) { // +9.8 æ˜¯æ‰£æ‰é‡åŠ›åŸºåº•
                shakeCooldown = true;
                shakeText.style.opacity = 1;
                shakeText.innerText = ["BOOM!", "POW!", "CRASH!"][Math.floor(Math.random()*3)];
                
                // æ–æ™ƒæ™‚çµ¦ä¸€å€‹é¡å¤–çš„å¼·åŠ›æ•£å°„ï¼Œé¿å…çƒèšåœ¨ä¸€èµ·
                balls.forEach(b => {
                    Body.applyForce(b, b.position, {
                        x: (Math.random() - 0.5) * 0.1 * b.mass,
                        y: (Math.random() - 0.5) * 0.1 * b.mass
                    });
                });

                setTimeout(() => {
                    shakeText.style.opacity = 0;
                    shakeCooldown = false;
                }, 300);
            }
        }

        function handleOrientation(e) {
            // é€™æ˜¯åŸæœ¬çš„å‚¾æ–œé‡åŠ›ï¼Œä¿æŒä¸è®Šï¼Œè² è²¬ã€Œå¹³ç·©ã€çš„æµå‹•
            const gx = Math.min(Math.max(e.gamma / 45, -1), 1);
            const gy = Math.min(Math.max(e.beta / 45, -1), 1);
            
            // è®“é‡åŠ›ç¨å¾®å¼·ä¸€é»
            engine.gravity.x = gx * 1.5;
            engine.gravity.y = gy * 1.5;
        }

        // --- UI ç¶å®š ---
        const panel = document.getElementById('control-panel');
        const toggleBtn = document.getElementById('toggle-btn');
        const inputs = {
            count: document.getElementById('input-count'),
            size: document.getElementById('input-size'),
            weight: document.getElementById('input-weight'),
            shake: document.getElementById('input-shake')
        };
        const values = {
            count: document.getElementById('val-count'),
            size: document.getElementById('val-size'),
            weight: document.getElementById('val-weight'),
            shake: document.getElementById('val-shake')
        };

        toggleBtn.addEventListener('click', () => {
            panel.classList.toggle('collapsed');
            toggleBtn.innerHTML = panel.classList.contains('collapsed') ? 'ğŸ› ï¸' : 'âŒ';
        });

        function updateUI(key) {
            const val = parseInt(inputs[key].value);
            config[key] = val;
            values[key].innerText = val;

            if(key === 'count' || key === 'size') {
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(rebuildBalls, 100);
            }
            if(key === 'weight') {
                updateBallWeights();
            }
        }

        Object.keys(inputs).forEach(key => {
            inputs[key].addEventListener('input', () => updateUI(key));
        });

        // --- å•Ÿå‹• ---
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');

        startBtn.addEventListener('click', () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(resp => {
                        if(resp === 'granted') startGame();
                        else alert('éœ€è¦æ„Ÿæ¸¬å™¨æ¬Šé™æ‰èƒ½éŠç©');
                    });
            } else {
                startGame();
            }
        });

        function startGame() {
            overlay.style.display = 'none';
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                updateWalls();
            });

            updateWalls();
            rebuildBalls();
            render();
        }

    </script>
</body>
</html>
