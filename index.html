<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>震動重力球池</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0f0c29, #302b63, #24243e); /* 神秘紫黑調 */
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }

        canvas { display: block; }

        /* --- 控制面板 --- */
        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 15, 25, 0.95);
            color: white;
            padding: 20px 25px;
            box-sizing: border-box;
            z-index: 100;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }

        #control-panel.collapsed {
            transform: translateY(-100%);
        }

        #toggle-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 101;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255,255,255,0.2);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .control-group:last-child { margin-bottom: 0; }
        
        .control-group label {
            width: 60px;
            font-size: 14px;
            color: #d1d1d1;
            font-weight: 600;
        }
        .control-group input {
            flex: 1;
            margin: 0 20px;
            cursor: pointer;
            height: 6px;
            border-radius: 3px;
            appearance: none;
            background: #444;
            outline: none;
        }
        /* 滑桿樣式美化 */
        .control-group input::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00c6ff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
        }

        .control-group span {
            width: 35px;
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            color: #00c6ff;
            font-family: monospace;
        }

        /* 啟動遮罩 */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 12, 20, 0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }

        #start-btn {
            padding: 20px 60px;
            font-size: 22px;
            background: linear-gradient(135deg, #ff00cc, #333399);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 40px rgba(255, 0, 204, 0.4);
            transition: transform 0.1s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        #start-btn:active { transform: scale(0.95); }

        #shake-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px;
            font-weight: 900;
            color: #fff;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 50px rgba(255, 0, 204, 0.8);
            z-index: 50;
            transition: opacity 0.1s;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn">進入體驗</button>
        <p style="color:#666; margin-top:25px; font-size:14px; max-width: 80%; text-align: center; line-height: 1.5;">
            Android 手機將支援震動回饋<br>iPhone 僅支援視覺特效
        </p>
    </div>

    <div id="shake-feedback">BOOM!</div>
    <button id="toggle-btn">⚙️</button>

    <div id="control-panel">
        <div class="control-group">
            <label>數量</label>
            <input type="range" id="input-count" min="20" max="300" value="100" step="10">
            <span id="val-count">100</span>
        </div>
        <div class="control-group">
            <label>大小</label>
            <input type="range" id="input-size" min="10" max="60" value="25" step="1">
            <span id="val-size">25</span>
        </div>
        <div class="control-group">
            <label style="color: #ff00cc;">重力</label>
            <input type="range" id="input-gravity" min="0" max="10" value="5" step="0.5">
            <span id="val-gravity">5</span>
        </div>
    </div>

    <canvas id="world"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        // --- Matter.js 設定 ---
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body;

        const engine = Engine.create();
        const world = engine.world;
        
        // 物理迭代優化
        engine.positionIterations = 8;
        engine.velocityIterations = 8;

        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        let balls = [];
        let walls = [];
        
        // 霓虹色系
        const colors = ['#FF00CC', '#333399', '#00CCFF', '#FFFF00', '#FF3300'];

        // 預設配置
        let config = {
            count: 100,
            radius: 25,
            gravity: 5, // 0~10
            shakeThreshold: 15 // 固定靈敏度
        };

        // --- 1. 牆壁 ---
        function updateWalls() {
            World.remove(world, walls);
            walls = [];
            const thick = 500; 
            const opts = { isStatic: true, render: { visible: false }, friction: 0.5 };
            
            walls.push(
                Bodies.rectangle(width/2, -thick/2, width*2, thick, opts), 
                Bodies.rectangle(width/2, height+thick/2, width*2, thick, opts), 
                Bodies.rectangle(-thick/2, height/2, thick, height*2, opts), 
                Bodies.rectangle(width+thick/2, height/2, thick, height*2, opts) 
            );
            World.add(world, walls);
        }

        // --- 2. 重力系統 ---
        function updateGravitySystem() {
            // 映射：滑桿 0~10 -> 重力 Scale 0 ~ 0.005
            // 0 = 漂浮
            // 1 = 0.0005 (月球重力)
            // 5 = 0.0025 (正常)
            // 10 = 0.005 (超重)
            const scale = config.gravity * 0.0005;
            engine.gravity.scale = scale;
        }

        // --- 3. 球體 ---
        function rebuildBalls() {
            World.remove(world, balls);
            balls = [];

            for(let i = 0; i < config.count; i++) {
                // 大小隨機 +/- 25%
                const r = config.radius * (0.75 + Math.random() * 0.5); 
                const x = Math.random() * (width - r*2) + r;
                const y = Math.random() * (height * 0.5) + 50;

                const ball = Bodies.circle(x, y, r, {
                    restitution: 0.6, 
                    friction: 0.001,  
                    frictionAir: 0.005, // 空氣阻力低一點比較順
                    density: 0.005, // 固定密度，讓重力 Scale 來控制整體感受
                    render: {
                        fillStyle: colors[Math.floor(Math.random() * colors.length)]
                    }
                });
                balls.push(ball);
            }
            World.add(world, balls);
        }

        // --- 4. 渲染 ---
        const stars = Array.from({length: 50}, () => ({
            x: Math.random()*width, y: Math.random()*height, r: Math.random()*2, a: Math.random()
        }));

        function render() {
            Engine.update(engine, 1000 / 60);
            ctx.clearRect(0, 0, width, height);

            // 背景星空 (帶閃爍)
            ctx.fillStyle = 'white';
            stars.forEach(s => {
                ctx.globalAlpha = Math.abs(Math.sin(Date.now() * 0.002 + s.x)) * s.a;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // 物理球
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.position.x, b.position.y, b.circleRadius, 0, Math.PI*2);
                ctx.fillStyle = b.render.fillStyle;
                ctx.fill();
                
                // 玻璃光澤
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(b.position.x - b.circleRadius*0.3, b.position.y - b.circleRadius*0.3, b.circleRadius*0.3, 0, Math.PI*2);
                ctx.fill();
            });

            requestAnimationFrame(render);
        }

        // --- 5. 震動與感測邏輯 ---
        
        let lastAcc = { x:0, y:0, z:0 };
        let shakeCooldown = false;
        const shakeText = document.getElementById('shake-feedback');

        // 觸發震動 (Haptic Feedback)
        function triggerVibration(intensity) {
            if (navigator.vibrate) {
                // 根據強度決定震動模式
                // 輕微: [50], 強烈: [50, 50, 100]
                if (intensity > 30) {
                     // 強震動：震-停-震
                    navigator.vibrate([50, 30, 150]); 
                } else {
                    // 輕震動
                    navigator.vibrate(50);
                }
            }
        }

        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if(!acc) return;

            const x = acc.x || 0;
            const y = acc.y || 0;
            const z = acc.z || 0;

            const deltaX = x - lastAcc.x;
            const deltaY = y - lastAcc.y;
            const deltaZ = z - lastAcc.z;

            // A. 慣性 (Inertia)
            const inertiaSensitivity = 0.001;
            if (Math.abs(deltaX) > 0.5 || Math.abs(deltaY) > 0.5) {
                balls.forEach(b => {
                    Body.applyForce(b, b.position, {
                        x: -deltaX * inertiaSensitivity * b.mass,
                        y: -deltaY * inertiaSensitivity * b.mass
                    });
                });
            }

            // B. 搖晃 (Shake)
            const totalDelta = Math.abs(deltaX) + Math.abs(deltaY) + Math.abs(deltaZ);
            
            if (!shakeCooldown && totalDelta > config.shakeThreshold) {
                shakeCooldown = true;
                
                // 1. 視覺回饋
                shakeText.style.opacity = 1;
                shakeText.style.transform = `translate(-50%, -50%) scale(${1 + Math.random()*0.5}) rotate(${Math.random()*20-10}deg)`;
                shakeText.innerText = ["BOOM!", "CRASH!", "POW!"][Math.floor(Math.random()*3)];

                // 2. 物理回饋 (炸裂)
                // 力道根據搖晃強度 (totalDelta) 決定
                const force = Math.min(totalDelta * 0.01, 0.3); 
                balls.forEach(b => {
                    Body.applyForce(b, b.position, {
                        x: (Math.random() - 0.5) * force * b.mass, 
                        y: (Math.random() - 0.5) * force * b.mass 
                    });
                });

                // 3. 觸覺回饋 (震動)
                triggerVibration(totalDelta);

                setTimeout(() => {
                    shakeText.style.opacity = 0;
                    shakeCooldown = false;
                }, 200); // 冷卻時間短一點，可以連續震動
            }

            lastAcc = { x, y, z };
        }

        function handleOrientation(e) {
            const g = e.gamma; 
            const b = e.beta;  
            if(g == null || b == null) return;

            let gx = Math.min(Math.max(g / 45, -1), 1);
            let gy = Math.min(Math.max(b / 45, -1), 1);

            // 只有當重力 scale > 0 時，方向才有意義
            // 這裡我們只更新方向，scale 由滑桿控制
            engine.gravity.x = gx;
            engine.gravity.y = gy;
        }

        // --- UI ---
        const panel = document.getElementById('control-panel');
        const toggleBtn = document.getElementById('toggle-btn');
        const inputs = {
            count: document.getElementById('input-count'),
            size: document.getElementById('input-size'),
            gravity: document.getElementById('input-gravity')
        };
        const values = {
            count: document.getElementById('val-count'),
            size: document.getElementById('val-size'),
            gravity: document.getElementById('val-gravity')
        };

        toggleBtn.addEventListener('click', () => {
            panel.classList.toggle('collapsed');
            toggleBtn.innerText = panel.classList.contains('collapsed') ? '⚙️' : '✕';
        });

        function updateConfig(key) {
            const val = parseFloat(inputs[key].value);
            config[key] = val;
            values[key].innerText = val; // 顯示數值

            if(key === 'count' || key === 'size') {
                clearTimeout(window.rebuildTimer);
                window.rebuildTimer = setTimeout(rebuildBalls, 100);
            }
            if(key === 'gravity') {
                updateGravitySystem();
            }
        }

        Object.keys(inputs).forEach(k => inputs[k].addEventListener('input', () => updateConfig(k)));

        // --- 啟動 ---
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');

        function startGame() {
            overlay.style.display = 'none';
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                updateWalls();
                clearTimeout(window.rebuildTimer);
                window.rebuildTimer = setTimeout(rebuildBalls, 150);
            });

            updateWalls();
            updateGravitySystem(); // 應用初始重力
            rebuildBalls();
            render();
        }

        startBtn.addEventListener('click', () => {
            // 嘗試觸發一次震動以獲取權限 (雖然在某些瀏覽器這沒用，但試試無妨)
            if(navigator.vibrate) navigator.vibrate(50);

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(r => { if (r === 'granted') startGame(); })
                    .catch(e => startGame());
            } else {
                startGame();
            }
        });

    </script>
</body>
</html>
