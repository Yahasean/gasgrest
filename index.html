<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·±æµ·çƒæ±  - é–‹ç™¼è€…æ¨¡å¼</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0f2027, #203a43, #2c5364);
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }

        canvas { display: block; }

        /* --- æ§åˆ¶é¢æ¿æ¨£å¼ --- */
        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            box-sizing: border-box;
            z-index: 100;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        #control-panel.collapsed {
            transform: translateY(-100%);
        }

        /* å±•é–‹/æ”¶åˆæŒ‰éˆ• */
        #toggle-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 101;
            background: #00c6ff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .control-group label {
            width: 80px;
            font-size: 14px;
            color: #aaa;
        }
        .control-group input {
            flex: 1;
            margin: 0 10px;
        }
        .control-group span {
            width: 30px;
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            color: #00c6ff;
        }

        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }

        #start-btn {
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            border: none;
            color: white;
            border-radius: 30px;
            cursor: pointer;
        }

        #shake-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 50px;
            font-weight: 900;
            color: #ffeb3b;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 30px orange;
            z-index: 50;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn">é–‹å§‹èª¿æ ¡ (START)</button>
        <p style="color:#666; margin-top:10px;">è«‹å…è¨±æ„Ÿæ¸¬å™¨æ¬Šé™</p>
    </div>

    <div id="shake-feedback">SHAKE!</div>

    <button id="toggle-btn">âš™ï¸</button>

    <div id="control-panel">
        <div class="control-group">
            <label>çƒçƒæ•¸é‡</label>
            <input type="range" id="input-count" min="10" max="400" value="120" step="10">
            <span id="val-count">120</span>
        </div>
        <div class="control-group">
            <label>çƒçƒå¤§å°</label>
            <input type="range" id="input-size" min="5" max="40" value="18" step="1">
            <span id="val-size">18</span>
        </div>
        <div class="control-group">
            <label>æ–æ™ƒåŠ›é“</label>
            <input type="range" id="input-shake" min="5" max="50" value="15" step="1">
            <span id="val-shake">15</span>
        </div>
        <div style="text-align: center; font-size: 12px; color: #666;">
            æ•¸å€¼è¶Šå°è¶Šå®¹æ˜“è§¸ç™¼æ–æ™ƒ
        </div>
    </div>

    <canvas id="world"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        // --- è®Šæ•¸èˆ‡è¨­å®š ---
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        // é è¨­åƒæ•¸
        let config = {
            count: 120,
            radius: 18,
            shakeThreshold: 15
        };

        // Matter.js æ¨¡çµ„
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body,
              Composite = Matter.Composite;

        const engine = Engine.create();
        const world = engine.world;
        let balls = [];
        let walls = [];
        
        const colors = ['#FF0055', '#00FFCC', '#FFFF00', '#00CCFF', '#AA00FF', '#FF9900'];

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // 1. å»ºç«‹/é‡å»º ç‰†å£
        function createWalls() {
            World.remove(world, walls);
            walls = [];
            const thick = 200;
            const opts = { isStatic: true, render: { visible: false } };
            
            walls.push(
                Bodies.rectangle(width/2, -thick/2, width+200, thick, opts), // ä¸Š
                Bodies.rectangle(width/2, height+thick/2, width+200, thick, opts), // ä¸‹
                Bodies.rectangle(-thick/2, height/2, thick, height+200, opts), // å·¦
                Bodies.rectangle(width+thick/2, height/2, thick, height+200, opts) // å³
            );
            World.add(world, walls);
        }

        // 2. é‡å»ºçƒé«” (ç•¶æ•¸é‡æˆ–å¤§å°æ”¹è®Šæ™‚)
        function rebuildBalls() {
            // æ¸…é™¤ç¾æœ‰çƒé«”
            World.remove(world, balls);
            balls = [];

            for(let i = 0; i < config.count; i++) {
                // éš¨æ©Ÿå¤§å°è®Šç•° (+- 20%)
                const r = config.radius * (0.8 + Math.random() * 0.4);
                const x = Math.random() * (width - 100) + 50;
                const y = Math.random() * (height / 2); // ä¸ŠåŠéƒ¨ç”Ÿæˆ

                const ball = Bodies.circle(x, y, r, {
                    restitution: 0.7,
                    friction: 0.005,
                    frictionAir: 0.01,
                    render: {
                        fillStyle: colors[Math.floor(Math.random() * colors.length)]
                    }
                });
                balls.push(ball);
            }
            World.add(world, balls);
        }

        // 3. æ¸²æŸ“è¿´åœˆ
        // èƒŒæ™¯æ°£æ³¡
        const bubbles = Array.from({length: 40}, () => ({
            x: Math.random()*width, y: Math.random()*height, r: Math.random()*5+1, s: Math.random()+0.5
        }));

        function render() {
            Engine.update(engine, 1000 / 60);
            ctx.clearRect(0, 0, width, height);

            // ç•«èƒŒæ™¯æ°£æ³¡
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            bubbles.forEach(b => {
                b.y -= b.s;
                if(b.y < 0) b.y = height;
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                ctx.fill();
            });

            // ç•«ç‰©ç†çƒ
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.position.x, b.position.y, b.circleRadius, 0, Math.PI*2);
                ctx.fillStyle = b.render.fillStyle;
                ctx.fill();
                
                // é«˜å…‰
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(b.position.x - b.circleRadius*0.3, b.position.y - b.circleRadius*0.3, b.circleRadius/3, 0, Math.PI*2);
                ctx.fill();
            });

            requestAnimationFrame(render);
        }

        // --- UI æ§åˆ¶é‚è¼¯ ---
        const panel = document.getElementById('control-panel');
        const toggleBtn = document.getElementById('toggle-btn');
        const inpCount = document.getElementById('input-count');
        const inpSize = document.getElementById('input-size');
        const inpShake = document.getElementById('input-shake');
        const valCount = document.getElementById('val-count');
        const valSize = document.getElementById('val-size');
        const valShake = document.getElementById('val-shake');

        // æ”¶åˆ/å±•é–‹
        toggleBtn.addEventListener('click', () => {
            panel.classList.toggle('collapsed');
            toggleBtn.innerText = panel.classList.contains('collapsed') ? 'ğŸ› ï¸' : 'ğŸ”¼';
        });

        // Debounce é˜²æŠ–å‹•ï¼šæ‹–æ›³æ»‘æ¡¿æ™‚ä¸è¦ç˜‹ç‹‚é‡ç®—ï¼Œåœä¸‹ä¾†æ‰ç®—
        let timeout;
        function updateConfig() {
            valCount.innerText = inpCount.value;
            valSize.innerText = inpSize.value;
            valShake.innerText = inpShake.value;

            config.shakeThreshold = parseInt(inpShake.value);
            
            // åªæœ‰æ•¸é‡æˆ–å¤§å°æ”¹è®Šæ™‚æ‰é‡å»ºç‰©ç†ä¸–ç•Œ
            const newCount = parseInt(inpCount.value);
            const newSize = parseInt(inpSize.value);
            
            if (newCount !== config.count || newSize !== config.radius) {
                config.count = newCount;
                config.radius = newSize;
                
                clearTimeout(timeout);
                timeout = setTimeout(rebuildBalls, 200); // åœé “ 0.2ç§’å¾ŒåŸ·è¡Œ
            }
        }

        inpCount.addEventListener('input', updateConfig);
        inpSize.addEventListener('input', updateConfig);
        inpShake.addEventListener('input', updateConfig);


        // --- æ„Ÿæ¸¬å™¨é‚è¼¯ ---
        let lastAcc = { x:0, y:0, z:0 };
        let shakeCooldown = false;
        const shakeFeedback = document.getElementById('shake-feedback');

        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            
            const dx = Math.abs(acc.x - lastAcc.x);
            const dy = Math.abs(acc.y - lastAcc.y);
            const dz = Math.abs(acc.z - lastAcc.z);

            if (!shakeCooldown && (dx + dy + dz) > config.shakeThreshold) {
                // è§¸ç™¼æ–æ™ƒ
                shakeCooldown = true;
                shakeFeedback.style.opacity = 1;
                
                balls.forEach(b => {
                    Body.applyForce(b, b.position, {
                        x: (Math.random()-0.5) * 0.2 * b.mass,
                        y: (Math.random()-0.5) * 0.2 * b.mass
                    });
                });

                setTimeout(() => {
                    shakeFeedback.style.opacity = 0;
                    shakeCooldown = false;
                }, 500);
            }
            lastAcc = { x: acc.x, y: acc.y, z: acc.z };
        }

        function handleOrientation(e) {
            const gx = Math.min(Math.max(e.gamma / 45, -1), 1);
            const gy = Math.min(Math.max(e.beta / 45, -1), 1);
            engine.gravity.x = gx;
            engine.gravity.y = gy;
        }

        // --- å•Ÿå‹• ---
        const startBtn = document.getElementById('start-btn');
        const startOverlay = document.getElementById('start-overlay');

        startBtn.addEventListener('click', () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(resp => {
                        if(resp === 'granted') initGame();
                        else alert('éœ€æˆæ¬Š');
                    });
            } else {
                initGame();
            }
        });

        function initGame() {
            startOverlay.style.display = 'none';
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                createWalls();
            });

            createWalls();
            rebuildBalls(); // åˆå§‹å»ºç«‹
            render();
        }

    </script>
</body>
</html>
